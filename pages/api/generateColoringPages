// pages/api/generateColoringPages.js

/**
 * Coloring page generator API
 *
 * URL: /api/generateColoringPages
 *
 * 이 핸들러는 절대 405(Method Not Allowed)를 반환하지 않습니다.
 * - GET, POST 모두 허용
 * - OPTIONS, HEAD 도 200 OK 로 처리
 *
 * 요청 형식:
 *   POST body: { story: string, locale?: 'en' | 'ko' | 'zh', pageCount?: number }
 *   GET  query: ?story=...&locale=en&pageCount=4
 *
 * 응답 형식:
 *   { pages: { index: number, text: string, imageUrl: string }[] }
 */

const OPENAI_IMAGE_URL = "https://api.openai.com/v1/images/generations";

/**
 * 스토리를 3~N개의 장면으로 나누는 간단한 헬퍼
 */
function splitStoryToScenes(story, targetCount = 4) {
  if (!story || typeof story !== "string") return [];

  const sentences = story
    .split(/[\n\r]+/)
    .join(" ")
    .split(/(?<=[.!?。？！])\s+/)
    .map((s) => s.trim())
    .filter((s) => s.length > 0);

  if (sentences.length === 0) return [];

  const scenes = [];
  const chunkSize = Math.max(1, Math.ceil(sentences.length / targetCount));

  for (let i = 0; i < sentences.length && scenes.length < targetCount; i += chunkSize) {
    const chunk = sentences.slice(i, i + chunkSize).join(" ");
    scenes.push(chunk);
  }

  return scenes;
}

/**
 * OpenAI 에 실제로 이미지를 한 장 생성 요청
 */
async function generateOneColoringImage({ apiKey, prompt }) {
  const res = await fetch(OPENAI_IMAGE_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      model: "gpt-image-1",
      prompt,
      n: 1,
      size: "1024x1024",
      style: "vivid",
    }),
  });

  if (!res.ok) {
    const text = await res.text();
    throw new Error(
      `OpenAI image API error: HTTP ${res.status} ${text}`
    );
  }

  const data = await res.json();
  const url = data?.data?.[0]?.url;
  if (!url) {
    throw new Error("OpenAI image API: no image URL in response");
  }
  return url;
}

export default async function handler(req, res) {
  // 0) 메서드에 관계없이 200만 보낸다.
  const method = (req.method || "GET").toUpperCase();

  // CORS / 프리플라이트 등 OPTIONS, HEAD도 허용
  if (method === "OPTIONS" || method === "HEAD") {
    res.status(200).json({ ok: true, pages: [] });
    return;
  }

  // 1) 공통 파라미터 파싱 (GET/POST 둘 다 지원)
  let story;
  let locale = "en";
  let pageCount = 4;

  if (method === "POST") {
    const body = req.body || {};
    story = body.story;
    if (body.locale) locale = String(body.locale);
    if (body.pageCount) pageCount = Number(body.pageCount) || 4;
  } else {
    // GET 등
    const q = req.query || {};
    story = q.story;
    if (q.locale) locale = String(q.locale);
    if (q.pageCount) pageCount = Number(q.pageCount) || 4;
  }

  if (!story || typeof story !== "string") {
    // story 가 없어도 200으로 보내되, 프론트엔드에서 메시지로 처리할 수 있게 함
    res.status(200).json({
      error: "NO_STORY_TEXT",
      pages: [],
    });
    return;
  }

  // 2) 스토리를 장면들로 분할
  const scenes = splitStoryToScenes(story, pageCount || 4);
  if (scenes.length === 0) {
    res.status(200).json({
      error: "FAILED_TO_SPLIT_STORY",
      pages: [],
    });
    return;
  }

  const apiKey = process.env.OPENAI_API_KEY;

  // 3) OpenAI 키가 없으면: 더미 페이지 한 장만 반환 (라우트/UX 디버깅용)
  if (!apiKey) {
    const demoPages = scenes.slice(0, 1).map((scene, index) => ({
      index,
      text: scene,
      // 아무 이미지나 테스트용으로 사용 – 실제에선 흑백 라인아트로 교체 가능
      imageUrl: "https://picsum.photos/seed/coloring-demo/1024/1024",
    }));

    res.status(200).json({
      pages: demoPages,
      warning:
        "OPENAI_API_KEY not set. Returning demo placeholder image instead of real coloring pages.",
    });
    return;
  }

  try {
    const localeHint =
      locale === "ko"
        ? "for a Korean child who is learning English"
        : locale === "zh"
        ? "for a Chinese child who is learning English"
        : "for a young child who is learning English";

    const pages = [];

    // 4) 장면별로 순차적으로(하나씩) 이미지 생성
    for (let i = 0; i < scenes.length; i++) {
      const sceneText = scenes[i];

      const prompt = `
Black-and-white line-art coloring page for children.
Clean bold outlines, no shading, no grey tones, no background colors, no text.
Printable coloring sheet with clear closed regions for tap-to-fill coloring.
The scene is ${localeHint}:
${sceneText}
      `.trim();

      const imageUrl = await generateOneColoringImage({
        apiKey,
        prompt,
      });

      pages.push({
        index: i,
        text: sceneText,
        imageUrl,
      });
    }

    res.status(200).json({ pages });
  } catch (err) {
    console.error("generateColoringPages error:", err);
    // 그래도 200으로 보내고, 프론트에서 에러 문구만 보여주게 함
    res.status(200).json({
      error: err?.message || "UNKNOWN_SERVER_ERROR",
      pages: [],
    });
  }
}
