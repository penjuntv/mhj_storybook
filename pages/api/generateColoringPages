// pages/api/generateColoringPages.js

/**
 * Step3: Coloring pages generator
 *
 * - Input: { story: string, locale?: "en" | "ko" | "zh", numPages?: number }
 * - Output: { pages: Array<{ id: string, prompt: string, url: string }> }
 *
 * Uses OpenAI image generation (line-art coloring style).
 */

export const config = {
  api: {
    bodyParser: true,
  },
};

const OPENAI_API_KEY = process.env.OPENAI_API_KEY;

if (!OPENAI_API_KEY) {
  // 빌드/런타임에서 바로 알아볼 수 있게 콘솔에 남겨 둠
  console.warn(
    "[generateColoringPages] OPENAI_API_KEY is not set. Coloring generation will fail."
  );
}

export default async function handler(req, res) {
  if (req.method !== "POST") {
    res.setHeader("Allow", "POST");
    return res
      .status(405)
      .json({ error: "Method Not Allowed. Use POST /api/generateColoringPages" });
  }

  try {
    const { story, locale = "en", numPages = 6 } = req.body || {};

    if (!story || typeof story !== "string") {
      return res
        .status(400)
        .json({ error: "Missing 'story' in request body." });
    }

    if (!OPENAI_API_KEY) {
      return res
        .status(500)
        .json({ error: "OPENAI_API_KEY is not configured on the server." });
    }

    const safeNum =
      typeof numPages === "number" && numPages > 0 && numPages <= 8
        ? Math.round(numPages)
        : 6;

    // 언어에 따라 살짝 설명만 바꿔 줌 (이미지는 어차피 비언어적이지만 힌트용)
    const localeHint =
      locale === "ko"
        ? "Korean kids' English storybook"
        : locale === "zh"
        ? "Chinese kids' English storybook"
        : "children's English storybook";

    const systemContent =
      "You are an illustrator for a children's coloring book. " +
      "Your job is to design simple, clear black-and-white line art scenes for kids aged 3–7. " +
      "Each scene must be:\n" +
      "- Strong, thick black outlines\n" +
      "- White background\n" +
      "- Closed regions for easy bucket-fill coloring\n" +
      "- No shading, no gray areas, no small noisy details\n" +
      "- Friendly, cute, and safe.";

    const userContent = `
Story (from a ${localeHint}): 

""" 
${story}
"""

Task:
1. Split this story into ${safeNum} simple visual scenes that match important moments.
2. For each scene, write a very short English prompt describing:
   - the main character(s),
   - the main action,
   - the background setting,
   - any key props (like apple, bunny doll, treasure chest).
3. The style must be: "black and white coloring page line art, thick outlines, cute, for kids, no text".

Return only a numbered list of ${safeNum} English prompts, one per line.
`;

    // 1) 먼저 장면별 프롬프트를 텍스트로 만든 뒤,
    // 2) 그 프롬프트들을 묶어서 이미지 생성에 사용
    const textResponse = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${OPENAI_API_KEY}`,
      },
      body: JSON.stringify({
        model: "gpt-4.1-mini",
        messages: [
          { role: "system", content: systemContent },
          { role: "user", content: userContent },
        ],
        temperature: 0.5,
      }),
    });

    if (!textResponse.ok) {
      const errorText = await textResponse.text();
      console.error("[generateColoringPages] text error:", errorText);
      return res
        .status(textResponse.status)
        .json({ error: "Failed to create scene prompts", detail: errorText });
    }

    const textData = await textResponse.json();
    const rawText = textData.choices?.[0]?.message?.content || "";
    const lines = rawText
      .split("\n")
      .map((l) => l.trim())
      .filter(Boolean);

    // "1. ..." 형식이면 앞 번호 제거
    const prompts = lines
      .slice(0, safeNum)
      .map((line) => line.replace(/^\d+[\).\-\:]\s*/, "").trim())
      .filter(Boolean);

    if (!prompts.length) {
      return res
        .status(500)
        .json({ error: "Failed to parse scene prompts from model output." });
    }

    // 이제 OpenAI 이미지 생성 (여러 장 한 번에)
    const imagePromptBase =
      "Black and white coloring book page for young kids, thick black outlines, no shading, simple shapes, full page scene, no text. Scene description: ";

    const imageResponse = await fetch("https://api.openai.com/v1/images/generations", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${OPENAI_API_KEY}`,
      },
      body: JSON.stringify({
        model: "gpt-image-1",
        prompt: prompts.map((p, idx) => `${idx + 1}) ${imagePromptBase}${p}`).join("\n"),
        n: prompts.length,
        size: "1024x1024",
        response_format: "url",
      }),
    });

    if (!imageResponse.ok) {
      const errorText = await imageResponse.text();
      console.error("[generateColoringPages] image error:", errorText);
      return res
        .status(imageResponse.status)
        .json({ error: "Failed to generate coloring images", detail: errorText });
    }

    const imageData = await imageResponse.json();
    const images = imageData.data || [];

    const pages = prompts.map((prompt, index) => {
      const url = images[index]?.url || null;
      return {
        id: `page-${index + 1}`,
        prompt,
        url,
      };
    });

    return res.status(200).json({ pages });
  } catch (err) {
    console.error("[generateColoringPages] Unexpected error:", err);
    return res.status(500).json({
      error: "Unexpected server error while generating coloring pages.",
    });
  }
}
