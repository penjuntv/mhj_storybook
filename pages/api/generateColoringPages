// pages/api/generateColoringPages.js

/**
 * Coloring page generator API
 *
 * 요청: POST /api/generateColoringPages
 * body: { story: string, locale?: 'en' | 'ko' | 'zh', pageCount?: number }
 *
 * 응답: { pages: { index: number, text: string, imageUrl: string }[] }
 *
 * - OpenAI Images API(DALL·E)를 사용해 흑백 라인아트(색칠공부용) 이미지를 생성합니다.
 * - OPENAI_API_KEY 환경변수가 필요합니다.
 */

const OPENAI_API_URL = "https://api.openai.com/v1/images/generations";

// 스토리를 문장 단위로 잘라서 4~8개의 장면 텍스트로 만드는 간단한 헬퍼
function splitStoryToScenes(story, targetCount = 4) {
  if (!story || typeof story !== "string") return [];

  // 줄바꿈 + 마침표 기준으로 문장 분리 (영어/한글 둘 다 대충 처리)
  const rawPieces = story
    .split(/[\n\r]+/)
    .join(" ")
    .split(/(?<=[.!?。？！])\s+/)
    .map((s) => s.trim())
    .filter((s) => s.length > 0);

  if (rawPieces.length === 0) return [];

  // targetCount 개수에 맞게 문장들을 묶어서 씬 텍스트 생성
  const scenes = [];
  const chunkSize = Math.max(1, Math.ceil(rawPieces.length / targetCount));

  for (let i = 0; i < rawPieces.length && scenes.length < targetCount; i += chunkSize) {
    const chunk = rawPieces.slice(i, i + chunkSize).join(" ");
    scenes.push(chunk);
  }

  return scenes;
}

export default async function handler(req, res) {
  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  const apiKey = process.env.OPENAI_API_KEY;
  if (!apiKey) {
    return res
      .status(500)
      .json({ error: "OPENAI_API_KEY is not set in environment variables." });
  }

  try {
    const { story, locale = "en", pageCount = 4 } = req.body || {};

    if (!story || typeof story !== "string") {
      return res.status(400).json({ error: "Missing 'story' in request body." });
    }

    const scenes = splitStoryToScenes(story, pageCount);
    if (scenes.length === 0) {
      return res
        .status(400)
        .json({ error: "Failed to extract scenes from story text." });
    }

    // 언어에 따라 살짝 다른 톤의 설명 (하지만 이미지는 항상 영어 프롬프트로 요청)
    const localeHint =
      locale === "ko"
        ? "for a Korean child learning English"
        : locale === "zh"
        ? "for a Chinese child learning English"
        : "for a young child learning English";

    const pages = [];

    for (let i = 0; i < scenes.length; i++) {
      const sceneText = scenes[i];

      const prompt = `
        Black-and-white line art coloring page for children, clean bold outlines,
        no shading, no grey tones, no text, printable coloring sheet.
        Scene ${i + 1} ${localeHint}:
        ${sceneText}
      `.trim();

      const response = await fetch(OPENAI_API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
          model: "gpt-image-1",
          prompt,
          n: 1,
          size: "1024x1024",
          style: "vivid",
        }),
      });

      if (!response.ok) {
        const text = await response.text();
        throw new Error(
          `Image API error (scene ${i + 1}): HTTP ${response.status} ${text}`
        );
      }

      const data = await response.json();
      const imageUrl = data?.data?.[0]?.url;

      if (!imageUrl) {
        throw new Error(`No image URL returned for scene ${i + 1}`);
      }

      pages.push({
        index: i,
        text: sceneText,
        imageUrl,
      });
    }

    return res.status(200).json({ pages });
  } catch (err) {
    console.error("generateColoringPages error:", err);
    return res
      .status(500)
      .json({ error: err?.message || "Unknown server error" });
  }
}
