// pages/api/generateColoringPages.js

/**
 * Coloring page generator API
 *
 * URL: /api/generateColoringPages
 *
 * Supports both GET and POST to avoid 405 issues:
 * - POST body: { story: string, locale?: 'en' | 'ko' | 'zh', pageCount?: number }
 * - GET  query: ?story=...&locale=en&pageCount=4
 *
 * Response: { pages: { index: number, text: string, imageUrl: string }[] }
 *
 * Uses OpenAI Images API (gpt-image-1) to create black-and-white line-art
 * coloring pages with clear bold outlines (Colorfy 스타일의 채우기용 그림).
 */

const OPENAI_API_URL = "https://api.openai.com/v1/images/generations";

// 스토리를 4~N개의 장면으로 나누는 헬퍼
function splitStoryToScenes(story, targetCount = 4) {
  if (!story || typeof story !== "string") return [];

  const rawPieces = story
    .split(/[\n\r]+/)
    .join(" ")
    .split(/(?<=[.!?。？！])\s+/)
    .map((s) => s.trim())
    .filter((s) => s.length > 0);

  if (rawPieces.length === 0) return [];

  const scenes = [];
  const chunkSize = Math.max(1, Math.ceil(rawPieces.length / targetCount));

  for (let i = 0; i < rawPieces.length && scenes.length < targetCount; i += chunkSize) {
    const chunk = rawPieces.slice(i, i + chunkSize).join(" ");
    scenes.push(chunk);
  }

  return scenes;
}

export default async function handler(req, res) {
  const apiKey = process.env.OPENAI_API_KEY;
  if (!apiKey) {
    return res
      .status(500)
      .json({ error: "OPENAI_API_KEY is not set in environment variables." });
  }

  try {
    const method = req.method || "GET";

    // 1) 메서드 종류와 상관없이 story, locale, pageCount 를 뽑아낸다.
    let story;
    let locale = "en";
    let pageCount = 4;

    if (method === "POST") {
      const body = req.body || {};
      story = body.story;
      if (body.locale) locale = body.locale;
      if (body.pageCount) pageCount = Number(body.pageCount) || 4;
    } else {
      // GET, HEAD, 기타 → query 에서 읽기
      const q = req.query || {};
      story = q.story;
      if (q.locale) locale = q.locale;
      if (q.pageCount) pageCount = Number(q.pageCount) || 4;
    }

    if (!story || typeof story !== "string") {
      return res.status(400).json({
        error: "Missing 'story' (story text is required).",
        receivedMethod: method,
      });
    }

    const scenes = splitStoryToScenes(story, pageCount);
    if (scenes.length === 0) {
      return res.status(400).json({
        error: "Failed to extract scenes from story text.",
      });
    }

    const localeHint =
      locale === "ko"
        ? "for a Korean child learning English"
        : locale === "zh"
        ? "for a Chinese child learning English"
        : "for a young child learning English";

    const pages = [];

    for (let i = 0; i < scenes.length; i++) {
      const sceneText = scenes[i];

      const prompt = `
Black-and-white line art coloring page for children.
Clean bold outlines, no shading, no grey tones, no colors, no text.
Printable coloring sheet with clear closed regions for tap-to-fill coloring.
Scene ${i + 1} ${localeHint}:
${sceneText}
      `.trim();

      const response = await fetch(OPENAI_API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
          model: "gpt-image-1",
          prompt,
          n: 1,
          size: "1024x1024",
          style: "vivid",
        }),
      });

      if (!response.ok) {
        const text = await response.text();
        throw new Error(
          `Image API error (scene ${i + 1}): HTTP ${response.status} ${text}`
        );
      }

      const data = await response.json();
      const imageUrl = data?.data?.[0]?.url;

      if (!imageUrl) {
        throw new Error(`No image URL returned for scene ${i + 1}`);
      }

      pages.push({
        index: i,
        text: sceneText,
        imageUrl,
      });
    }

    return res.status(200).json({ pages });
  } catch (err) {
    console.error("generateColoringPages error:", err);
    return res
      .status(500)
      .json({ error: err?.message || "Unknown server error" });
  }
}
