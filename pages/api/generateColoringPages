// pages/api/generateColoringImages.js

/**
 * Generate coloring-page-style line-art images based on a story text.
 *
 * Request body (JSON):
 * {
 *   story: string,       // required, full English story text
 *   maxScenes?: number   // optional, default 4, max 8
 * }
 *
 * Response body (JSON):
 * {
 *   scenes: Array<{
 *     index: number,
 *     prompt: string,
 *     imageUrl: string
 *   }>
 * }
 */

const TEXT_API_URL = "https://api.openai.com/v1/chat/completions";
const IMAGE_API_URL = "https://api.openai.com/v1/images/generations";

export default async function handler(req, res) {
  if (req.method !== "POST") {
    res.setHeader("Allow", ["POST"]);
    return res.status(405).json({ error: "Method Not Allowed" });
  }

  const apiKey = process.env.OPENAI_API_KEY || process.env.OPENAI_API_TOKEN;
  if (!apiKey) {
    return res.status(500).json({
      error:
        "OPENAI_API_KEY (or OPENAI_API_TOKEN) is not set in environment variables.",
    });
  }

  try {
    const { story, maxScenes = 4 } = req.body || {};

    if (!story || typeof story !== "string" || !story.trim()) {
      return res.status(400).json({
        error: "Request body must include a non-empty 'story' string.",
      });
    }

    const limit =
      typeof maxScenes === "number"
        ? Math.min(Math.max(1, maxScenes), 8)
        : 4;

    // 1단계: 스토리를 장면 프롬프트 리스트로 변환
    const scenePrompts = await createScenePromptsFromStory(
      apiKey,
      story,
      limit
    );

    if (!Array.isArray(scenePrompts) || scenePrompts.length === 0) {
      return res.status(500).json({
        error: "Failed to create scene prompts from story.",
      });
    }

    // 2단계: 각 장면 프롬프트마다 컬러링용 선 그림 생성
    const scenes = [];
    for (let i = 0; i < scenePrompts.length; i++) {
      const prompt = scenePrompts[i];
      const imageUrl = await generateLineArtImage(apiKey, prompt);
      if (imageUrl) {
        scenes.push({
          index: i,
          prompt,
          imageUrl,
        });
      }
    }

    if (scenes.length === 0) {
      return res.status(500).json({
        error: "Failed to generate any images for the scenes.",
      });
    }

    return res.status(200).json({ scenes });
  } catch (err) {
    console.error("generateColoringImages error:", err);
    return res.status(500).json({
      error: "Unexpected server error while generating coloring images.",
    });
  }
}

/**
 * 스토리 텍스트를 받아서, 1~N개의 장면 프롬프트(영어)를 JSON 배열로 만들어 달라고 GPT에게 요청
 */
async function createScenePromptsFromStory(apiKey, story, maxScenes) {
  const systemPrompt =
    "You are a children's picture-book storyboard artist. " +
    "Given a short English children's story, you extract the key scenes " +
    "that would become individual pages of a picture book.";

  const userPrompt = `
Read the following English children's story and select ${maxScenes} key moments
that would make good picture-book pages.

For each key moment, write ONE short ENGLISH prompt that describes:
- who is in the scene,
- what they are doing,
- a few simple background details,
- but keep it suitable for a black-and-white line-art coloring page
  (no detailed shading, keep shapes clear and simple, avoid tiny details).

Return your answer as a PURE JSON array of strings, like:

[
  "A child and her mother are baking cookies in a bright kitchen...",
  "The child walks to school with a backpack and a friend on a sunny morning...",
  ...
]

Do NOT add any extra text before or after the JSON.
Do NOT add comments.
Do NOT add a title or explanation.

Story:
"""${story.trim()}"""
`.trim();

  const response = await fetch(TEXT_API_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: userPrompt },
      ],
      temperature: 0.6,
    }),
  });

  if (!response.ok) {
    const text = await response.text();
    console.error("Scene prompt API error:", response.status, text);
    throw new Error("Failed to create scene prompts");
  }

  const data = await response.json();
  const content = data?.choices?.[0]?.message?.content || "";

  // JSON 파싱 시도
  try {
    // 혹시 앞뒤에 이상한 텍스트가 붙으면 첫 '['부터 마지막 ']'까지만 사용
    const start = content.indexOf("[");
    const end = content.lastIndexOf("]");
    const jsonStr =
      start >= 0 && end >= start ? content.slice(start, end + 1) : content;
    const arr = JSON.parse(jsonStr);
    return (arr || [])
      .filter((item) => typeof item === "string" && item.trim().length > 0)
      .slice(0, maxScenes);
  } catch (e) {
    console.error("Failed to parse scene prompts JSON:", e, content);
    throw new Error("Invalid JSON from scene prompt generation");
  }
}

/**
 * 장면 프롬프트를 받아서, 유아용 컬러링북 스타일의 선 그림 이미지를 생성
 */
async function generateLineArtImage(apiKey, scenePrompt) {
  const fullPrompt = `
Black-and-white line-art coloring page for children aged 3–5.

Requirements:
- Thick, clean black outlines only, white background.
- No grey shading, no colors, no text.
- Simple shapes, big areas that are easy to color.
- Cute, warm, non-scary style.
- Focus on the main characters and a few clear background elements.
- The image must be suitable for a digital coloring app.

Scene:
${scenePrompt}
`.trim();

  const response = await fetch(IMAGE_API_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      model: "gpt-image-1",
      prompt: fullPrompt,
      n: 1,
      size: "1024x1024",
    }),
  });

  if (!response.ok) {
    const text = await response.text();
    console.error("Image API error:", response.status, text);
    return null;
  }

  const data = await response.json();
  const url = data?.data?.[0]?.url;
  return typeof url === "string" && url.length > 0 ? url : null;
}
